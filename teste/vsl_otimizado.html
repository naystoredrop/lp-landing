<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VSL</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- hls.js para tocar o manifesto HLS da Cloudflare -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root{ --brand:#ff6a00; --bg:#000; --fg:#fff; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{ width:100%; max-width:none; margin:0; }

    /* PLAYER: sem aspecto fixo, sem sombra, sem borda arredondada */
    .vsl{
      position:relative;
      width:100%;
      /* Altura é definida via JS pela proporção real do vídeo.
         Para evitar "tela preta" até carregar metadata, usamos um mínimo temporário.
         Isso NÃO é um aspecto fixo: é apenas um fallback visual. */
      min-height:50vh;
      height:auto;
      background:#000;
      overflow:hidden;
    }
    video{
      position:absolute; inset:0;
      width:100%; height:100%;
      background:#000;
      object-fit:contain; /* nunca corta nem estica */
      border:0; display:block;
    }

    /* Overlays */
    .overlay{
      position:absolute; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center;
      transition:opacity .25s ease;
      background:#000;
    }
    .overlay.hide{ opacity:0; pointer-events:none }

    /* CAPA 1 — GIF (start) */
    .cover img,
    .resume img{
      width:100%; height:100%; object-fit:contain; display:block; cursor:pointer;
      user-select:none; -webkit-user-drag:none;
      background:#000;
    }

    /* CAPA 2 — PNG (retomar) + botões */
    .resume{ z-index:11; display:none; }
    .resume.show{ display:flex }
    .actions{
      position:absolute; left:0; right:0; bottom:8%;
      display:flex; gap:12px; justify-content:center; flex-wrap:wrap; padding:0 16px;
    }
    .btn{
      padding:12px 18px; border-radius:999px; border:2px solid transparent;
      font-weight:800; font-size:18px; cursor:pointer;
      background:#111; color:#fff;
    }
    .btn-primary{ background:var(--brand); color:#000 }
    .btn-ghost{ background:#00000088; color:#fff; border-color:#ffffff44 }

    /* Barra estilo VTurb (sem sombra) */
    .progress{
      position:absolute; left:0; right:0; bottom:0; z-index:5;
      height:8px; background:rgba(255,255,255,.12);
      pointer-events:none;
    }
    .progress span{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg,#ff6a00,#ffb347);
      transition:width .18s ease-out;
    }

    /* Loading simples */
    .loading{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      z-index:6; pointer-events:none;
      font-size:14px; opacity:.7;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="vsl" id="vslBox">
      <!-- Vídeo real (HLS) -->
      <video id="vsl" playsinline webkit-playsinline preload="metadata"></video>

      <!-- Loading -->
      <div class="loading" id="loading" aria-hidden="true">Carregando…</div>

      <!-- CAPA 1: GIF -->
      <div class="overlay cover" id="cover">
        <img src="capathumilai.gif" alt="Clique para iniciar com som" onerror="this.style.display='none'">
      </div>

      <!-- CAPA 2: PNG (retomar) -->
      <div class="overlay resume" id="resume">
        <img src="capathumilaicontinuar.png" alt="Retomar vídeo" onerror="this.style.display='none'">
        <div class="actions">
          <button class="btn btn-primary" id="btnContinue">▶ Continuar assistindo</button>
          <button class="btn btn-ghost" id="btnRestart">↻ Ver desde o início</button>
        </div>
      </div>

      <!-- Barra -->
      <div class="progress"><span id="bar"></span></div>
    </div>
  </div>

  <script>
    /************* CONFIG *************/
    const VIDEO_ID = '10d249a46e42039201d0fec47f6d1f5b';
    const CUSTOMER_SUB = 'customer-b2gdb94hrid04n5r.cloudflarestream.com';
    const HLS_SRC = `https://${CUSTOMER_SUB}/${VIDEO_ID}/manifest/video.m3u8`;
    const RESUME_KEY = `vsl:${VIDEO_ID}:time`;
    const OFFER_AFTER = 15;   // só oferece "continuar" após 15s assistidos
    /**********************************/

    const video = document.getElementById('vsl');
    const cover = document.getElementById('cover');
    const resume = document.getElementById('resume');
    const btnContinue = document.getElementById('btnContinue');
    const btnRestart  = document.getElementById('btnRestart');
    const bar = document.getElementById('bar');
    const box = document.getElementById('vslBox');
    const loading = document.getElementById('loading');

    // helpers
    const getSaved  = () => Number(localStorage.getItem(RESUME_KEY)) || 0;
    const saveTime  = (t) => localStorage.setItem(RESUME_KEY, String(Math.max(0, Math.floor(t||0))));
    const clearTime = () => localStorage.removeItem(RESUME_KEY);

    // ---- Ajuste DINÂMICO de proporção com base no vídeo real ----
    let ratio = null; // videoHeight / videoWidth

    function applyBoxHeight(){
      const w = box.clientWidth || window.innerWidth;
      if (ratio && isFinite(ratio) && ratio > 0){
        box.style.height = (w * ratio) + 'px';
        box.style.minHeight = '0px'; // remove fallback assim que tivermos a proporção real
      }
    }
    function computeAndApplyRatio(){
      if (video.videoWidth > 0 && video.videoHeight > 0){
        ratio = video.videoHeight / video.videoWidth;
        applyBoxHeight();
      }
    }
    // Update responsivo
    const ro = new ResizeObserver(applyBoxHeight);
    ro.observe(box);
    window.addEventListener('orientationchange', applyBoxHeight);
    window.addEventListener('resize', applyBoxHeight);

    function setLoading(v){
      loading.style.display = v ? 'flex' : 'none';
    }

    // Carrega HLS e inicia no ponto desejado
    function loadAndPlay(startSec){
      const startAt = Math.max(0, Number(startSec)||0);
      setLoading(true);

      function setStartAndPlay(){
        const onMeta = () => {
          computeAndApplyRatio();
          try { video.currentTime = startAt; } catch(_) {}
          video.muted = false;
          video.play().catch(()=>{});
          setLoading(false);
        };
        if (video.readyState >= 1) { onMeta(); }
        else video.addEventListener('loadedmetadata', onMeta, { once:true });
      }

      if (window.Hls && Hls.isSupported()){
        const hls = new Hls({lowLatencyMode:false});
        hls.loadSource(HLS_SRC);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, setStartAndPlay);
        hls.on(Hls.Events.ERROR, function(event, data){
          // Mostra capa de retomar como fallback
          resume.classList.add('show');
          cover.classList.add('hide');
          setLoading(false);
          console.warn('HLS error', data);
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')){
        // Safari iOS/macOS toca HLS nativo
        video.src = HLS_SRC;
        setStartAndPlay();
      } else {
        // Fallback direto
        video.src = HLS_SRC;
        setStartAndPlay();
      }
    }

    // Decide capa ao abrir
    (function init(){
      const s = getSaved();
      // Sempre começamos mostrando alguma capa (nada de tela preta).
      if (s >= OFFER_AFTER){
        resume.classList.add('show');
        cover.classList.add('hide');
      } else {
        resume.classList.remove('show');
        cover.classList.remove('hide');
      }
      setLoading(false);
    })();

    // Capa 1 (GIF) → iniciar do zero
    cover.addEventListener('click', ()=>{
      cover.classList.add('hide');
      resume.classList.remove('show');
      loadAndPlay(0);
    });

    // Capa 2 (PNG) → continuar/reiniciar
    btnContinue.addEventListener('click', ()=>{
      resume.classList.remove('show');
      loadAndPlay(getSaved());
    });
    btnRestart.addEventListener('click', ()=>{
      clearTime();
      resume.classList.remove('show');
      loadAndPlay(0);
    });

    // Barra + salvamento com tempo REAL
    video.addEventListener('timeupdate', ()=>{
      const t = Number(video.currentTime)||0;
      const d = Number(video.duration)||1;
      bar.style.width = Math.min(100, (t/d)*100).toFixed(2) + '%';
      if (!video.paused) saveTime(t);
    });

    video.addEventListener('loadedmetadata', computeAndApplyRatio);

    video.addEventListener('ended', ()=>{
      bar.style.width = '100%';
      clearTime();
      // Ao terminar, oferece reiniciar
      resume.classList.add('show');
      cover.classList.add('hide');
    });

    window.addEventListener('beforeunload', ()=>{
      saveTime(Number(video.currentTime)||0);
    });
  </script>
</body>
</html>
